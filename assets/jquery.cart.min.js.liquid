/*
 * Module to add a shipping rates calculator to cart page.
 *
 * Copyright (c) 2011-2016 Caroline Schnapp (11heavens.com)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
*/
/* MODIFIED to support translation (province/state is only set for en language) */
"object"==typeof Countries&&(Countries.updateProvinceLabel=function(a,b){if("string"==typeof a&&Countries[a]&&Countries[a].provinces){if("object"!=typeof b&&(b=document.getElementById("address_province_label"),null===b))return;b.innerHTML=Countries[a].label;var c=jQuery(b).parent();c.find("select");c.find(".custom-style-select-box-inner").html(Countries[a].provinces[0])}}),"undefined"==typeof Shopify.Cart&&(Shopify.Cart={}),Shopify.Cart.ShippingCalculator=function(){var _config={submitButton:"Calculate shipping",submitButtonDisabled:"Calculating...",templateId:"shipping-calculator-response-template",wrapperId:"wrapper-response",customerIsLoggedIn:!1,currentLanguage:"en",moneyFormat:"${{amount}}"},_render=function(a){var b=jQuery("#"+_config.templateId),c=jQuery("#"+_config.wrapperId);if(b.length&&c.length){_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var d=_.template(jQuery.trim(b.text())),e=d(a);if(jQuery(e).appendTo(c),"undefined"!=typeof Currency&&"function"==typeof Currency.convertAll){var f="";jQuery("[name=currencies]").length?f=jQuery("[name=currencies]").val():jQuery("#currencies span.selected").length&&(f=jQuery("#currencies span.selected").attr("data-currency")),""!==f&&Currency.convertAll(Sunrise.strings.shop_currency,f,"#wrapper-response span.price-money, #estimated-shipping span.price-money")}}},_enableButtons=function(){jQuery(".get-rates").removeAttr("disabled").removeClass("disabled").val(_config.submitButton)},_disableButtons=function(){jQuery(".get-rates").val(_config.submitButtonDisabled).attr("disabled","disabled").addClass("disabled")},_getCartShippingRatesForDestination=function(a){var b={type:"POST",url:"/cart/prepare_shipping_rates",data:jQuery.param({shipping_address:a}),success:_pollForCartShippingRatesForDestination(a),error:_onError};jQuery.ajax(b)},_pollForCartShippingRatesForDestination=function(a){var b=function(){jQuery.ajax("/cart/async_shipping_rates",{dataType:"json",success:function(c,d,e){200===e.status?_onCartShippingRatesUpdate(c.shipping_rates,a):setTimeout(b,500)},error:_onError})};return b},_fullMessagesFromErrors=function(a){var b=[];return jQuery.each(a,function(a,c){jQuery.each(c,function(c,d){b.push(a+" "+d)})}),b},_onError=function(XMLHttpRequest,textStatus){jQuery("#estimated-shipping").hide(),jQuery("#estimated-shipping em").empty(),_enableButtons();var feedback="",data=eval("("+XMLHttpRequest.responseText+")");feedback=data.message?data.message+"("+data.status+"): "+data.description:"Error : "+_fullMessagesFromErrors(data).join("; ")+".","Error : country is not supported."===feedback&&(feedback="We do not ship to this destination."),_render({rates:[],errorFeedback:feedback,success:!1}),jQuery("#"+_config.wrapperId).show()},_onCartShippingRatesUpdate=function(a,b){_enableButtons();var c="";if(b.zip&&(c+=b.zip+", "),b.province&&(c+=b.province+", "),c+=b.country,a.length){"0.00"==a[0].price?jQuery("#estimated-shipping em").html("FREE"):jQuery("#estimated-shipping em").html(_formatRate(a[0].price));for(var d=0;d<a.length;d++)a[d].price=_formatRate(a[d].price)}_render({rates:a,address:c,success:!0}),jQuery("#"+_config.wrapperId+", #estimated-shipping").fadeIn()},_formatRate=function(a){function e(a,b){return"undefined"==typeof a?b:a}function f(a,b,c,d){if(b=e(b,2),c=e(c,","),d=e(d,"."),isNaN(a)||null==a)return 0;a=(a/100).toFixed(b);var f=a.split("."),g=f[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+c),h=f[1]?d+f[1]:"";return g+h}if("function"==typeof Shopify.formatMoney)return Shopify.formatMoney(a,_config.moneyFormat);"string"==typeof a&&(a=a.replace(".",""));var b="",c=/\{\{\s*(\w+)\s*\}\}/,d=_config.moneyFormat;switch(d.match(c)[1]){case"amount":b=f(a,2);break;case"amount_no_decimals":b=f(a,0);break;case"amount_with_comma_separator":b=f(a,2,".",",");break;case"amount_no_decimals_with_comma_separator":b=f(a,0,".",",")}return d.replace(c,b)};return _init=function(){if(new Shopify.CountryProvinceSelector("address_country","address_province",{hideElement:"address_province_container"}),"en"==_config.currentLanguage){var a=jQuery("#address_country"),b=jQuery("#address_province_label").get(0);"undefined"!=typeof Countries&&(Countries.updateProvinceLabel(a.val(),b),a.change(function(){Countries.updateProvinceLabel(a.val(),b)}))}jQuery(".get-rates").click(function(){_disableButtons(),jQuery("#"+_config.wrapperId).empty().hide();var a={};a.zip=jQuery("#address_zip").val()||"",a.country=jQuery("#address_country").val()||"",a.province=jQuery("#address_province").val()||"",_getCartShippingRatesForDestination(a)}),_config.customerIsLoggedIn&&jQuery(".get-rates:eq(0)").trigger("click")},{show:function(a){a=a||{},jQuery.extend(_config,a),jQuery(function(){_init()})},getConfig:function(){return _config},formatRate:function(a){return _formatRate(a)}}}();
